#!/bin/bash
# Post-receive hook: update working copy after push
# Fixes permissions automatically (files may be owned by root from Docker)

VAULT_DIR=/srv/nazar/vault
LOG_FILE=/srv/nazar/data/git-sync.log

echo "$(date): Received push, updating working copy..." >> "$LOG_FILE"

# Fix permissions first (files may be owned by root from Docker container)
chown -R debian:vault "$VAULT_DIR" 2>/dev/null || true
chmod -R u+rw "$VAULT_DIR" 2>/dev/null || true

# Update working copy
if cd "$VAULT_DIR"; then
    git --git-dir=/srv/nazar/vault.git --work-tree="$VAULT_DIR" checkout -f main >> "$LOG_FILE" 2>&1
    
    # Fix permissions again after checkout (new files may have wrong ownership)
    chown -R debian:vault "$VAULT_DIR" 2>/dev/null || true
    chmod -R u+rw "$VAULT_DIR" 2>/dev/null || true
    find "$VAULT_DIR" -type d -exec chmod 2775 {} + 2>/dev/null || true
    
    echo "$(date): Working copy updated" >> "$LOG_FILE"
else
    echo "$(date): ERROR - Could not cd to $VAULT_DIR" >> "$LOG_FILE"
    exit 1
fi
