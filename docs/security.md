# Security Model

Defense-in-depth approach: multiple independent layers, each protecting against different threats.

## Security Layers

```
┌──────────────────────────────────────────────────┐
│  Layer 1: Network (Tailscale + UFW)              │
│  Only Syncthing sync ports are public            │
├──────────────────────────────────────────────────┤
│  Layer 2: Authentication (SSH keys + tokens)     │
│  No passwords anywhere                           │
├──────────────────────────────────────────────────┤
│  Layer 3: Container Isolation (Docker)           │
│  Agent only sees /vault, nothing else            │
├──────────────────────────────────────────────────┤
│  Layer 4: Agent Sandbox (OpenClaw)               │
│  Group chat sessions are sandboxed               │
├──────────────────────────────────────────────────┤
│  Layer 5: Secrets Separation                     │
│  API keys in .env, never in vault                │
├──────────────────────────────────────────────────┤
│  Layer 6: Auto-Patching                          │
│  Unattended security upgrades daily              │
└──────────────────────────────────────────────────┘
```

## Layer Details

### 1. Network — Tailscale + UFW

**Firewall rules (UFW):**

| Port | Protocol | Interface | Purpose |
|------|----------|-----------|---------|
| 22 | TCP | `tailscale0` only | SSH (not public) |
| 22000 | TCP/UDP | `0.0.0.0` | Syncthing file sync |
| 21027 | UDP | `0.0.0.0` | Syncthing discovery |
| Everything else | — | — | DENIED |

**Not exposed to public internet:**
- Gateway API — bound to loopback, exposed via integrated Tailscale Serve (`tailscale: { mode: "serve" }` in docker-compose). Accessible only at `https://<tailscale-hostname>/` within your tailnet. Tailscale identity headers handle authentication automatically. No `trustedProxies` configuration needed since the proxy is integrated.
- Syncthing UI (8384) — bound to `127.0.0.1`, proxied via manual `tailscale serve --tcp 8384`
- SSH (22) — locked to `tailscale0` interface

**`tailscale serve` proxies:** The Syncthing UI is bound to `127.0.0.1` and not directly reachable from the Tailscale interface. `tailscale serve --tcp` proxies tailnet traffic to localhost, keeping it accessible only within your tailnet. The gateway does not need this — it manages its own Tailscale Serve proxy automatically via integrated serve mode.

**Tailscale provides:**
- WireGuard-based encrypted tunnel
- Device authentication via your Tailscale account
- NAT traversal — works behind any firewall
- MagicDNS for easy `nazar-vps` hostname access

### 2. Authentication

**SSH:**
- Key-only authentication (passwords disabled)
- Root login disabled
- Only the `nazar` user is allowed to SSH in (`AllowUsers nazar`). The default cloud provider user (e.g., `debian`) is not permitted after setup.
- TCP forwarding enabled (required for VSCode Remote SSH)
- Max 3 auth attempts per connection
- Fail2Ban bans IPs after 3 failed attempts (1 hour ban)

**OpenClaw Gateway:**
- Token-based auth (auto-generated 32-byte hex token)
- Token stored in `.env` on host, passed via environment variable
- Gateway rejects unauthenticated requests

**Syncthing:**
- Device ID authentication (cryptographic identity)
- Only pre-approved devices can connect
- UI password set during first access

### 3. Container Isolation

The OpenClaw container has limited access:

| What | Access |
|------|--------|
| `/vault` | Read/write (bind mount) |
| `/home/node/.openclaw` | Read/write (config + state) |
| Host filesystem | None (beyond bind mounts) |
| Host network | Yes (`network_mode: host`) — binds to loopback only |
| Other containers | None (default Docker network isolation) |

The container runs as `node` user (uid 1000), not root.

### 4. Agent Sandbox (OpenClaw)

OpenClaw's sandbox mode: `non-main`

- **Direct chats** (main session with you): Full vault access, no sandbox
- **Group chats / channels**: Sandboxed in Docker — isolated filesystem, no network, memory limited to 1GB, 1 CPU

Sandbox config in `openclaw.json`:
```json
{
  "sandbox": {
    "mode": "non-main",
    "docker": {
      "binds": ["/srv/nazar/vault:/vault:rw"],
      "network": "none",
      "memory": "1g",
      "cpus": 1,
      "user": "1000:1000"
    }
  }
}
```

### 5. Secrets Management

**Where secrets live:**
- `/srv/nazar/.env` — API keys, gateway token, WhatsApp number
- Never committed to git (`.gitignore` excludes `.env`)
- Never stored in the vault (audit script checks for leaked keys)

**What's in `.env`:**
```
OPENCLAW_GATEWAY_TOKEN=<auto-generated>
ANTHROPIC_API_KEY=sk-ant-...
KIMI_API_KEY=sk-...
WHATSAPP_NUMBER=+40...
```

**Passed to container via:** Docker Compose `env_file` directive — container reads them as environment variables, never written to disk inside the container.

### 6. Auto-Patching

Unattended upgrades are enabled for:
- Debian security updates
- Debian stable updates

Automatic reboot at 04:00 if a kernel update requires it. Unused kernels and dependencies are auto-removed.

## Threat Model

| Threat | Mitigation |
|--------|-----------|
| SSH brute force | Key-only auth + Fail2Ban + Tailscale-only |
| Public port scanning | Only 22000/21027 exposed; no services on other ports |
| Unauthorized gateway access | Token auth + bound to 127.0.0.1 |
| Container escape | Non-root user, limited mounts, loopback-only binding (host network) |
| Vault data exfiltration | Agent sandbox in group chats, MEMORY.md not loaded in groups |
| Stale vulnerabilities | Unattended upgrades, auto-reboot |
| Leaked API keys | Separate .env file, audit script checks vault for keys |
| Syncthing interception | P2P TLS encryption, device ID authentication |
| Lost VPS access | Tailscale as backup path, VPS provider web console as last resort |

## Security Audit

Run the audit script anytime to check all layers:

```bash
sudo bash vault/99-system/openclaw/skills/vps-setup/scripts/audit-vps.sh
```

Checks:
1. Root login disabled
2. Password auth disabled
3. SSH restricted to `nazar` user
4. UFW active with correct rules
5. Gateway/Syncthing UI not publicly exposed
6. Fail2Ban running
7. Auto-updates enabled
8. Tailscale connected
9. Docker containers running
10. No API keys in vault files

## Emergency Access

If Tailscale goes down and you're locked out of SSH:

1. Use your VPS provider's web console (OVH: KVM, Hetzner: Console)
2. Log in as `nazar`
3. Re-enable public SSH: `sudo ufw allow 22/tcp`
4. Fix Tailscale: `sudo tailscale up`
5. Re-lock SSH: `sudo bash lock-ssh-to-tailscale.sh`
