services:
  openclaw-gateway:
    build:
      context: ${OPENCLAW_SRC:-/opt/openclaw}
      dockerfile: Dockerfile.nazar
    container_name: nazar-gateway
    restart: unless-stopped
    network_mode: host
    env_file: .env
    environment:
      - HOME=/home/node
      - NODE_ENV=production
      - OPENCLAW_GATEWAY_BIND=loopback
      - OPENCLAW_GATEWAY_PORT=${OPENCLAW_GATEWAY_PORT:-18789}
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - VAULT_PATH=/vault
      - VOICE_VENV=/opt/voice-venv
      - WHISPER_MODEL_DIR=/opt/models/whisper
      - PIPER_MODEL_DIR=/opt/models/piper
    volumes:
      # OpenClaw config + state (persisted on host)
      - ${OPENCLAW_CONFIG_DIR:-./data/openclaw}:/home/node/.openclaw
      # Workspace points INTO the vault
      - ${VAULT_DIR:-./vault}/${OPENCLAW_WORKSPACE_PATH:-99-system/openclaw/workspace}:/home/node/.openclaw/workspace
      # Vault access (read/write for agent)
      - ${VAULT_DIR:-./vault}:/vault:rw
      # Tailscale socket (for integrated tailscale serve mode)
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock
    # No ports section â€” host networking binds directly; tailscale serve handles HTTPS
    command: ["node", "dist/index.js", "gateway", "--bind", "loopback", "--port", "18789", "--tailscale", "serve", "--allow-unconfigured"]
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:18789').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  syncthing:
    image: syncthing/syncthing:latest
    container_name: nazar-syncthing
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - ${VAULT_DIR:-./vault}:/var/syncthing/vault
      - ./data/syncthing:/var/syncthing/config
    ports:
      - "127.0.0.1:8384:8384"     # Syncthing UI (Tailscale only)
      - "22000:22000/tcp"           # Sync protocol
      - "22000:22000/udp"
      - "21027:21027/udp"           # Discovery
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8384"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
